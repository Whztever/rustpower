# 简介

电力系统潮流计算是电气工程本科的基础专业课，是稳态分析的主要工具之一。它的目标是在确定电力系统负荷以及发电厂有功功率出力的情况下确定各节点电压的数值，同时确定各个线路节点的功率流向以及发电厂的有功无功功率。虽然电力系统本质是是一个电路图，并且以节点电压法作为分析的基础，但是传统教科书上的电力系统潮流分析往往是从单独的节点方程来进行教学，并且也没有提供现代化的计算机编程实践。本文将以向量化的理论和目前流行Rust语言，结合现今先进的软件工程技术来介绍我开发的Rust语言编写的开源潮流计算程序：RustPower，供大家技术交流学习以及教学参考使用。

# 技术理念与实现动机

目前，网络上开源的电力系统稳态分析软件有MatPower，PyPower，PandaPower和PyPSA，这些开源软件都采用了Matlab和Python环境中的数值计算以及稀疏矩阵库，对于工科的科学计算任务来说编写起来十分友好。但是Matlab和Python都是动态脚本语言，没有静态类型检查，并且性能也受到限制（Python目前还有全局锁），Matlab本身也需要商业授权才能合法使用。此外，Python动态的语言特性带来方便的同时也使得在编译时检查出程序错误变得困难。
相对而言，采用Rust语言将有以下优势：
1. Rust是静态的内存安全的语言，相对于C++而言它无须垃圾回收器也不需要用户手工管理内存分配就可以确保内存正确分配和释放，可以在实现同等性能的算法程序的情况下避免C++和C语言程序的内存泄露和野指针的问题，十分有利于复杂的并行计算程序，并且获得远超Python程序的内存占用以及运行效率的优势。并且Rust也可以用于嵌入式的环境，甚至在单片机上运行。
2. Rust 不采用继承关系，因为传统面向对象编程中的继承会导致随着软件修改而逐渐膨胀的依赖关系。例如，对基类接口的修改不可避免地会破坏所有子类的实现，这对软件升级和重构是灾难性的。Rust 采用组合的思路，通过使用 Trait 作为接口来修饰数据结构体，从而实现面向对象的多态特性。这一特点尤其适用于编写数值计算程序。
3. Rust 的生态环境和开发工具非常完善。相对于 C++ 主要依赖于标准范围外的 CMake 进行构建，Rust 将开发环境、软件包管理、模块管理、单元测试和语法命名规则等全部集成在语言本身中，无须一套自定义的复杂规范和生成工具，使得使用 Rust 的启动成本低于 C++。

另一方面的动机来源于这些年来的实践以及电力系统电磁暂态和实时仿真的研究成果，我相信可以用电路图理论和线性代数语言来描述稳态潮流计算问题并且实现更加高效简洁的程序。这一点是PyPower和Pandapower等程序并没有做到的。下面就解释我在实现这个程序中依据的理论基础。

# 最初的理论，最初的电路仿真
本文以及本程序实现潮流计算的基本理论自然是人尽皆知的基尔霍夫电流定律（KCL）和节点电压法，电力系统稳态，机电暂态和电磁暂态都源于此。对于一个RLC构成的线性电路，有 
$$
\begin{equation}
\begin{aligned}
         \sum \bm{i}_{out} & = \bm{i}_{L} + \bm{i}_{C} + \bm{i}_{G}\\ 
            &=Y_{L}\int  \bm{v} 
             dt + Y_{C}\frac{d \bm{v  }}{dt} + Y_{G}\bm{v} = \bm{s}, \\ 
             Y_L &= D_L^T [\frac{1}{\bm{L}}] D_{L}, 
             Y_C = D_C^T [\bm{C}] D_{C}, 
             Y_G = D_G^T [\bm{G}] D_{G},
\end{aligned}
\end{equation}
$$
其中，$D$ 是有向关联矩阵，其行对应物理组件，列对应节点；$L$ 是电感，$C$ 是电容，$G$ 是导纳，$\bm s$ 是由源引起的电流注入向量。$D$ 是一个将全局节点电压 $\bm v$ 转换为端口电压的变换矩阵，而 $D^T$ 可以将支路电流分散到节点注入向量中。$Y$ 矩阵是不同类型组件的加权拉普拉斯矩阵，也称为导纳矩阵，在求解电网方程系统中起着重要作用。$[X]$ 表示一维向量 $X$ 的对角矩阵。(1)这个形式的KCL公式使得任意类型的电气元件都可以被表达为支路组件形式。对这个连续时间域的公式进行拉普拉斯变换就可以轻松得到稳态和机电暂态分析的基本公式。RustPower中就是依据这个公式去组装$Y_{bus}$的。
<!-- $$
\begin{equation}
\begin{aligned}
         \bm I_{bus} = Y_{bus}\bm V_{bus}
\end{aligned}
\end{equation}
$$
在这里的$\bm I_bus$是注入到节点的电源造成的电流，经过拉普拉斯变换后向量和矩阵内都为复数，也就是在频域或者相域工频的值。RustPower中就是依据这个公式去组装$Y_{bus}$的。  -->
关于用这个公式做EMT仿真的其他详情可见于我的论文：
```
T. Cheng, T. Duan and V. Dinavahi, "ECS-Grid: Data-Oriented Real-Time Simulation Platform for Cyber-Physical Power Systems," in IEEE Transactions on Industrial Informatics, vol. 19, no. 11, pp. 11128-11138, Nov. 2023, doi: 10.1109/TII.2023.3244329.
```
在一般的公开文献中似乎只能看到对于单个节点的KCL，正如教材中只有单个节点的潮流计算公式一样。实际上，这个矩阵表达形式来源于最初的电路仿真理论。在上世纪70年代，使用计算机进行电路仿真的理论就已经被提出并且实现了，其最早期的代表是SPICE和EMTP等Fortran程序，在当时只是一些函数的集合，在现代看来十分原始。我国在80年代也有很多学者对这些曾经还是这种幼崽阶段的EDA程序软件进行过研究，如东南大学的XXX写的《》教材。上面也有类似的基于图论的矩阵形式表述。在此我不禁感叹，当年的电子信息技术潮流当中并不缺少中国人研究去EDA软件，却不知为何在大约40年后成了“卡脖子”技术，令人唏嘘。 

言归正传，在过去几十年之所以不使用矩阵表达形式是有深刻的原因的。主要是过去计算机没有现在的内存和计算性能，而且稀疏矩阵的算法也成熟于上世纪九十年代，连存储矩阵都十分困难，更不要说执行高性能的矩阵并行计算了。然而现代的计算机可以十分轻松的处理这些矩阵，即使有几百万个节点也不在话下，因此采用矩阵的形式将有望更好的利用现代计算机的向量化并行计算能力，这就是为什么我强调了我的程序的理论基础是这样的矩阵表达的KCL公式。